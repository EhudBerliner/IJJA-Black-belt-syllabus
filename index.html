<style>
    .calibration-box {
        background: #fff3cd;
        border: 2px dashed #ffeeba;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        font-family: monospace;
        font-weight: bold;
        color: #856404;
    }
    #player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
</style>

<div class="calibration-box">
    <div>זמן התחלה בקישור: <span id="cal-start">0</span> ש'</div>
    <div style="font-size: 1.4em; margin: 5px 0;">משך זמן נוכחי: <span id="cal-duration">0</span> שניות</div>
    <div style="font-size: 0.8em; color: #666;">(עצור את הוידיאו בנקודת הסיום והעתק את המספר לעמודה G)</div>
</div>

<div id="videoContainer" class="video-container">
    <div id="player"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    let ytPlayer;
    let calibrationInterval;
    let currentVideoStart = 0;

    // פונקציה חובה של יוטיוב שמתעוררת כשה-API מוכן
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', {
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            // התחלת עדכון הטיימר כשהוידיאו רץ
            calibrationInterval = setInterval(updateCalibration, 100);
        } else {
            // עצירת העדכון כשהוידיאו עוצר
            clearInterval(calibrationInterval);
        }
    }

    function updateCalibration() {
        if (ytPlayer && ytPlayer.getCurrentTime) {
            const now = ytPlayer.getCurrentTime();
            const diff = Math.max(0, Math.floor(now - currentVideoStart));
            document.getElementById('cal-duration').innerText = diff;
        }
    }

    // פונקציית עזר לחילוץ ה-ID וה-Start מהלינק
    function getYoutubeData(url) {
        let id = '', start = 0;
        if (url.includes('v=')) id = url.split('v=')[1].split('&')[0];
        else if (url.includes('embed/')) id = url.split('embed/')[1].split('?')[0];
        else if (url.includes('youtu.be/')) id = url.split('youtu.be/')[1].split('?')[0];
        
        const tMatch = url.match(/[?&](t|start)=([0-9]+)/);
        if (tMatch) start = parseInt(tMatch[2]);
        
        return { id, start };
    }

    // עדכון פונקציית ה-OpenV הקיימת שלך
    function openV(ex, isRand) {
        currentEx = ex;
        document.getElementById('vPath').innerText = `${ex.cat} > ${ex.ser}`;
        document.getElementById('vName').innerText = ex.name;
        
        const data = getYoutubeData(ex.embed || ex.link);
        currentVideoStart = data.start;
        document.getElementById('cal-start').innerText = data.start;
        document.getElementById('cal-duration').innerText = "0";

        document.getElementById('vModal').style.display = 'flex';
        document.getElementById('videoContainer').style.display = 'block';

        // טעינת הוידיאו לנגן
        if (ytPlayer && ytPlayer.loadVideoById) {
            ytPlayer.loadVideoById({
                videoId: data.id,
                startSeconds: data.start
            });
        }
    }

    function closeV() {
        document.getElementById('vModal').style.display = 'none';
        if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
        clearInterval(calibrationInterval);
    }
</script>
