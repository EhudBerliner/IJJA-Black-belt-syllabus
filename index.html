<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056a6">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black belt syllabus - v2.2.7</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056a6;
            --secondary: #009be5;
            --border: #d2dce5;
            --header-h: 90px;
            --fav-color: #ffc107;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Heebo', sans-serif; background: #f7f9fb; color: #333; overflow: hidden; }

        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-h);
            background: var(--primary); color: white; padding: 10px 15px;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-bottom { display: flex; gap: 10px; margin-bottom: 5px; }

        #app { margin-top: var(--header-h); height: calc(100vh - var(--header-h)); overflow-y: auto; padding: 10px; }
        
        .cat-box { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .cat-title { background: #eee; padding: 12px; font-weight: 900; border-bottom: 1px solid var(--border); color: var(--primary); }
        .ser-title { padding: 10px 15px; font-weight: 700; background: #fdfdfd; display: flex; justify-content: space-between; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .ex-list { display: none; list-style: none; padding: 0; margin: 0; background: white; }
        .ex-list.open { display: block; }
        .ex-row { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f9f9f9; }
        .ex-info { flex: 1; font-weight: 400; cursor: pointer; }
        .fav-btn { padding: 5px 10px; cursor: pointer; color: #ccc; font-size: 1.2em; }
        .fav-btn.active { color: var(--fav-color); }
        .hidden { display: none !important; }

        /* Modal */
        #vModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; }
        .modal-box { position: relative; width: 100%; max-width: 600px; margin: auto; background: white; padding-bottom: 20px; border-radius: 15px; overflow: hidden; }
        .video-container { position: relative; width: 100%; padding-top: 56.25%; background: #000; }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Video Cover (Mask) */
        #videoCover { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #111; z-index: 10; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; cursor: pointer;
        }

        .btn { border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; font-family: inherit; }
        .btn-fav-filter { background: white; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .btn-fav-filter.active { background: var(--fav-color); color: #000; }
        .btn-random { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; }
        .close-modal { position: absolute; top: 10px; right: 10px; font-size: 2em; color: white; z-index: 1100; cursor: pointer; text-shadow: 0 2px 5px #000; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div style="font-weight:900; font-size:1.2em;">סילבוס חגורה שחורה <small style="font-size:0.6em; opacity:0.8;">v2.2.7</small></div>
        <button class="btn btn-random" onclick="playRandom()"><i class="fas fa-dice"></i> מבחן אקראי</button>
    </div>
    <div class="header-bottom">
        <button id="favFilterBtn" class="btn btn-fav-filter" onclick="toggleFavFilter()">
            <i class="fas fa-star"></i> מועדפים
        </button>
        <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="toggleAll()">
            <i class="fas fa-expand-arrows-alt"></i> פתיחת הכל
        </button>
    </div>
</header>

<div id="app">טוען נתונים...</div>

<div id="vModal">
    <span class="close-modal" onclick="closeV()">&times;</span>
    <div class="modal-box">
        <div class="video-container">
            <div id="player"></div>
            <div id="videoCover" class="hidden" onclick="revealVideo()">
                <i class="fas fa-question-circle" style="font-size: 4em; margin-bottom: 15px; color: var(--fav-color);"></i>
                <div style="font-size: 1.2em; font-weight: 900;">נחש את הטכניקה</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">לחץ כאן לצפייה בפתרון</div>
            </div>
        </div>
        <div style="padding:15px; text-align:center;">
            <h3 id="vName" style="margin:0 0 5px 0;"></h3>
            <div id="calDuration" style="font-size:0.8em; color:#666;"></div>
        </div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let db = [];
    let favs = [];
    let isFavOnly = false;
    let ytPlayer = null;
    let currentEx = null;
    let watchdog = null;
    let isRandomMode = false;

    /** 1. טעינת נתונים **/
    async function init() {
        const savedFavs = localStorage.getItem('ijja_favs');
        if(savedFavs) favs = JSON.parse(savedFavs);

        try {
            const res = await fetch('Black_belt_syllabus_IJJA.csv?v=' + Date.now());
            const text = await res.text();
            db = parseCSV(text);
            render();
        } catch(e) { document.getElementById('app').innerText = "שגיאה בטעינת הקובץ."; }
    }

    /** 2. פארסר CSV עמיד לפסיקים **/
    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        const results = [];
        // Regex שמזהה פסיק רק אם הוא מחוץ למירכאות
        const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

        for(let i=1; i<lines.length; i++) {
            const cols = lines[i].split(regex).map(c => c.replace(/^"|"$/g, '').trim());
            if(cols.length < 6) continue;
            results.push({
                id: i-1, cat: cols[0], ser: cols[1], num: cols[2],
                name: cols[3], link: cols[4], embed: cols[5],
                duration: parseInt(cols[6]) || 10
            });
        }
        return results;
    }

    /** 3. תצוגה **/
    function render() {
        const app = document.getElementById('app');
        let html = '';
        const structure = {};

        db.forEach(ex => {
            if(!structure[ex.cat]) structure[ex.cat] = {};
            if(!structure[ex.cat][ex.ser]) structure[ex.cat][ex.ser] = [];
            structure[ex.cat][ex.ser].push(ex);
        });

        for(let cat in structure) {
            html += `<div class="cat-box">
                <div class="cat-title">${cat}</div>`;
            for(let ser in structure[cat]) {
                html += `<div class="ser-title" onclick="toggleSer(this)">
                    <span>${ser}</span> <i class="fas fa-chevron-down"></i>
                </div>
                <ul class="ex-list">`;
                structure[cat][ser].forEach(ex => {
                    const isFav = favs.includes(ex.id);
                    html += `<li class="ex-row" data-id="${ex.id}">
                        <div class="ex-info" onclick="openV(${db.indexOf(ex)})">
                            <span style="color:var(--secondary); font-weight:900;">${ex.num}</span> ${ex.name}
                        </div>
                        <div class="fav-btn ${isFav?'active':''}" onclick="toggleFav(${ex.id}, this)">
                            <i class="fa${isFav?'s':'r'} fa-star"></i>
                        </div>
                    </li>`;
                });
                html += `</ul>`;
            }
            html += `</div>`;
        }
        app.innerHTML = html;
        applyFilters();
    }

    function toggleSer(el) {
        const list = el.nextElementSibling;
        list.classList.toggle('open');
        const icon = el.querySelector('i');
        icon.className = list.classList.contains('open') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    }

    function toggleFav(id, el) {
        if(favs.includes(id)) favs = favs.filter(i => i !== id);
        else favs.push(id);
        localStorage.setItem('ijja_favs', JSON.stringify(favs));
        el.classList.toggle('active');
        el.querySelector('i').className = favs.includes(id) ? 'fas fa-star' : 'far fa-star';
        if(isFavOnly) applyFilters();
    }

    function toggleFavFilter() {
        isFavOnly = !isFavOnly;
        document.getElementById('favFilterBtn').classList.toggle('active', isFavOnly);
        applyFilters();
    }

    function applyFilters() {
        document.querySelectorAll('.cat-box').forEach(c => {
            let catHasVisible = false;
            c.querySelectorAll('.ser-title').forEach(s => {
                const list = s.nextElementSibling;
                let serHasVisible = false;
                list.querySelectorAll('.ex-row').forEach(row => {
                    const id = parseInt(row.dataset.id);
                    const hide = isFavOnly && !favs.includes(id);
                    row.classList.toggle('hidden', hide);
                    if(!hide) serHasVisible = true;
                });
                s.classList.toggle('hidden', isFavOnly && !serHasVisible);
                list.classList.toggle('hidden', isFavOnly && !serHasVisible);
                if(serHasVisible) catHasVisible = true;
            });
            c.classList.toggle('hidden', isFavOnly && !catHasVisible);
        });
    }

    function toggleAll() {
        const lists = document.querySelectorAll('.ex-list:not(.hidden)');
        const anyClosed = Array.from(lists).some(l => !l.classList.contains('open'));
        lists.forEach(l => {
            l.classList.toggle('open', anyClosed);
            const icon = l.previousElementSibling.querySelector('i');
            if(icon) icon.className = anyClosed ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        });
    }

    /** 4. נגן וידאו **/
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', {
            playerVars: { 'autoplay': 0, 'modestbranding': 1, 'rel': 0, 'iv_load_policy': 3, 'playsinline': 1 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(event) {
        if(event.data == YT.PlayerState.PLAYING) startWatchdog();
        else clearInterval(watchdog);
    }

    function openV(idx) {
        currentEx = db[idx];
        document.getElementById('vName').innerText = currentEx.name;
        document.getElementById('calDuration').innerText = "זמן מוצג: " + currentEx.duration + " שניות";
        document.getElementById('vModal').style.display = 'flex';
        
        // וידוא שהכיסוי מוסתר בפתיחה רגילה
        if(!isRandomMode) document.getElementById('videoCover').classList.add('hidden');

        const videoId = extractId(currentEx.embed);
        const startSec = extractStart(currentEx.embed);
        
        ytPlayer.loadVideoById({
            videoId: videoId,
            startSeconds: startSec
        });
    }

    function startWatchdog() {
        clearInterval(watchdog);
        const startSec = extractStart(currentEx.embed);
        watchdog = setInterval(() => {
            const curr = ytPlayer.getCurrentTime();
            if(curr - startSec >= currentEx.duration) {
                ytPlayer.seekTo(startSec);
            }
        }, 500);
    }

    function closeV() {
        document.getElementById('vModal').style.display = 'none';
        ytPlayer.stopVideo();
        clearInterval(watchdog);
        isRandomMode = false; // איפוס תמיד בסגירה
    }

    function extractId(url) {
        const parts = url.split('/');
        return parts[parts.length-1].split('?')[0];
    }

    function extractStart(url) {
        const match = url.match(/start=(\d+)/);
        return match ? parseInt(match[1]) : 0;
    }

    /** 5. מצב מבחן אקראי **/
    function playRandom() {
        const pool = db.filter(x => x.duration > 0);
        if(pool.length === 0) return;
        
        isRandomMode = true;
        const randEx = pool[Math.floor(Math.random() * pool.length)];
        
        // הצגת הכיסוי לפני טעינת הסרטון
        document.getElementById('videoCover').classList.remove('hidden');
        openV(db.indexOf(randEx));
    }

    function revealVideo() {
        document.getElementById('videoCover').classList.add('hidden');
        ytPlayer.playVideo();
    }

    window.onload = init;
</script>

</body>
</html>
