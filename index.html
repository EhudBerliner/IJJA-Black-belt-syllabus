<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007aff">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Syllabus for black belts - IJJA</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056a6;
            --secondary: #009be5;
            --border: #d2dce5;
            --header-h: 110px;
            --fav-color: #ffc107;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
            font-family: 'Heebo', sans-serif;
            background-color: #f7f9fb;
            color: #333;
        }

        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 8px 15px;
            box-sizing: border-box;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            height: 45px;
            width: auto;
        }

        .title-area h1 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 900;
        }

        .title-area p {
            margin: 0;
            font-size: 0.8rem;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 6px;
            /* הזזת הכפתורים למעלה מהקו */
            margin-bottom: 8px; 
        }

        .controls button {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .controls button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .danger-btn { color: #dc3545; }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        #searchInput {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #f8fafc;
        }

        main {
            margin-top: var(--header-h);
            height: calc(100% - var(--header-h));
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        .category-wrap { margin-bottom: 15px; }
        .category-title {
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .series {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 4px;
            overflow: hidden;
        }

        .series-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }

        .series.active .series-header { background: #f0f7ff; }

        .exercise-list { display: none; border-top: 1px solid #eee; }
        .exercise-list.expanded { display: block; }

        .exercise {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }

        .exercise:last-child { border-bottom: none; }
        .exercise-name { flex: 1; cursor: pointer; }

        .fav-star {
            color: #ccc;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .fav-star.active { color: var(--fav-color); }

        .hidden { display: none !important; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        .close-modal {
            position: absolute;
            top: -30px; left: 0;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo-area">
            <img src="Logo.png" alt="Logo" class="logo">
            <div class="title-area">
                <h1>Syllabus (v1.0.1)</h1>
                <p>IJJA Black Belts</p>
            </div>
        </div>
        <div class="controls">
            <button id="toggleAllBtn" onclick="toggleAllAccordions()">
                <i class="fas fa-arrows-alt-v"></i>
            </button>
            <button id="favFilterBtn" onclick="toggleFavFilter()">
                <i class="fas fa-star"></i>
            </button>
            <button id="clearFavsBtn" onclick="clearAllFavs()" class="danger-btn">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="חפש תרגיל..." oninput="handleSearch()">
    </div>
</header>

<main id="content"></main>

<div id="videoModal" class="modal" onclick="closeVideo()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeVideo()">&times;</span>
        <div class="video-container">
            <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let favorites = JSON.parse(localStorage.getItem('ijja_favs') || "[]");
    let isFavFilterActive = false;
    let allExpanded = false;

    async function loadData() {
        try {
            const response = await fetch('Black_belt_syllabus_IJJA.csv');
            const csvText = await response.text();
            parseCSV(csvText);
            renderSyllabus();
        } catch (e) { console.error(e); }
    }

    function parseCSV(text) {
        const lines = text.split('\n').filter(l => l.trim());
        allData = lines.slice(1).map(line => {
            const v = line.split(',');
            return { category: v[0], series: v[1], id: v[2], name: v[3], link: v[4] };
        });
    }

    function renderSyllabus() {
        const container = document.getElementById('content');
        container.innerHTML = '';
        const cats = [...new Set(allData.map(d => d.category))];

        cats.forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category-wrap';
            catDiv.innerHTML = `<div class="category-title">${cat}</div>`;
            
            const series = [...new Set(allData.filter(d => d.category === cat).map(d => d.series))];
            series.forEach(ser => {
                const serDiv = document.createElement('div');
                serDiv.className = 'series';
                serDiv.innerHTML = `
                    <div class="series-header" onclick="toggleSeries(this)">
                        <span>${ser}</span><i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="exercise-list"></div>
                `;
                const list = serDiv.querySelector('.exercise-list');
                allData.filter(d => d.category === cat && d.series === ser).forEach(ex => {
                    const exDiv = document.createElement('div');
                    exDiv.className = 'exercise';
                    exDiv.innerHTML = `
                        <i class="fas fa-star fav-star ${favorites.includes(ex.link)?'active':''}" onclick="toggleFav('${ex.link}', this)"></i>
                        <div class="exercise-name" onclick="openVideo('${ex.link}')">${ex.name}</div>
                    `;
                    list.appendChild(exDiv);
                });
                catDiv.appendChild(serDiv);
            });
            container.appendChild(catDiv);
        });
    }

    function toggleSeries(el) {
        const s = el.parentElement;
        s.classList.toggle('active');
        s.querySelector('.exercise-list').classList.toggle('expanded');
    }

    function openVideo(url) {
        if (!url) return;
        const embed = url.replace("youtu.be/", "www.youtube.com/embed/").replace("watch?v=", "embed/");
        document.getElementById('videoFrame').src = embed;
        document.getElementById('videoModal').style.display = 'flex';
    }

    function closeVideo() {
        document.getElementById('videoModal').style.display = 'none';
        document.getElementById('videoFrame').src = '';
    }

    function toggleFav(link, el) {
        event.stopPropagation(); // מונע פתיחת וידאו כשלוחצים על הכוכב
        if (favorites.includes(link)) {
            favorites = favorites.filter(f => f !== link);
            el.classList.remove('active');
        } else {
            favorites.push(link);
            el.classList.add('active');
        }
        localStorage.setItem('ijja_favs', JSON.stringify(favorites));
        if (isFavFilterActive) applyFavFilter();
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.exercise').forEach(ex => {
            ex.classList.toggle('hidden', !ex.innerText.toLowerCase().includes(term));
        });
        document.querySelectorAll('.series').forEach(ser => {
            const has = ser.querySelectorAll('.exercise:not(.hidden)').length > 0;
            ser.classList.toggle('hidden', !has);
        });
    }

    function toggleFavFilter() {
        isFavFilterActive = !isFavFilterActive;
        document.getElementById('favFilterBtn').classList.toggle('active', isFavFilterActive);
        applyFavFilter();
    }

    function applyFavFilter() {
        document.querySelectorAll('.category-wrap').forEach(w => {
            const exercises = w.querySelectorAll('.exercise');
            let hasVisibleEx = false;
            
            exercises.forEach(ex => {
                const isFav = ex.querySelector('.fav-star').classList.contains('active');
                if (isFavFilterActive) {
                    ex.classList.toggle('hidden', !isFav);
                    if (isFav) hasVisibleEx = true;
                } else {
                    ex.classList.remove('hidden');
                    hasVisibleEx = true;
                }
            });

            w.querySelectorAll('.series').forEach(ser => {
                const has = ser.querySelectorAll('.exercise:not(.hidden)').length > 0;
                ser.classList.toggle('hidden', !has);
            });
            
            w.classList.toggle('hidden', !hasVisibleEx);
        });
    }

    function toggleAllAccordions() {
        allExpanded = !allExpanded;
        document.querySelectorAll('.series').forEach(s => {
            s.classList.toggle('active', allExpanded);
            s.querySelector('.exercise-list').classList.toggle('expanded', allExpanded);
        });
        document.getElementById('toggleAllBtn').innerHTML = allExpanded ? '<i class="fas fa-arrows-alt-v"></i>' : '<i class="fas fa-arrows-alt-v"></i>';
    }

    function clearAllFavs() {
        if(confirm("למחוק מועדפים?")) {
            favorites = []; localStorage.setItem('ijja_favs', "[]");
            document.querySelectorAll('.fav-star').forEach(s => s.classList.remove('active'));
            if(isFavFilterActive) applyFavFilter();
        }
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    loadData();
</script>
</body>
</html>
