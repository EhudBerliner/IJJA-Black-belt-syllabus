<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056a6">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>סילבוס חגורות שחורות - IJJA</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056a6;
            --secondary: #009be5;
            --border: #d2dce5;
            --header-h: 170px; /* הותאם למיקום הכפתורים החדש */
            --fav-color: #ffc107;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
            font-family: 'Heebo', sans-serif;
            background-color: #f7f9fb;
            color: #333;
        }

        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            box-sizing: border-box;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .logo {
            height: 50px;
            width: auto;
            object-fit: contain;
        }

        .title-area h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 900;
        }

        .title-area p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        /* כפתורי שליטה מעל לקו */
        .controls {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .controls button {
            flex: 1;
            padding: 8px 5px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            max-width: 120px;
        }

        .controls button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .danger-btn { color: #dc3545; }

        /* חיפוש */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        #searchInput {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 2px solid #edf2f7;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #f8fafc;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
        }

        /* רשימת תכנים */
        main {
            margin-top: var(--header-h);
            height: calc(100% - var(--header-h));
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        .category-wrap { margin-bottom: 15px; }
        .category-title {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .series {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .series-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }

        .series-header i {
            transition: transform 0.3s;
            color: var(--secondary);
        }

        .series.active .series-header i { transform: rotate(180deg); }

        .exercise-list {
            display: none;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .exercise-list.expanded { display: block; }

        .exercise {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }

        .exercise:last-child { border-bottom: none; }

        .exercise-name { flex: 1; cursor: pointer; }

        .fav-star {
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }

        .fav-star.active { color: var(--fav-color); }

        .hidden { display: none !important; }

        /* Modal וידאו */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            width: 95%;
            max-width: 800px;
            position: relative;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 8px;
        }

        .close-modal {
            position: absolute;
            top: -40px; left: 0;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo-area">
            <img src="Logo.png" alt="IJJA Logo" class="logo">
            <div class="title-area">
                <h1>Syllabus - Black Belts</h1>
                <p>איגוד הג'וג'יטסו בישראל</p>
            </div>
        </div>

        <div class="controls">
            <button id="toggleAllBtn" onclick="toggleAllAccordions()">
                <i class="fas fa-arrows-alt-v"></i> פתח הכל
            </button>
            <button id="favFilterBtn" onclick="toggleFavFilter()">
                <i class="fas fa-star"></i> מועדפים
            </button>
            <button id="clearFavsBtn" onclick="clearAllFavs()" class="danger-btn">
                <i class="fas fa-trash-alt"></i> נקה
            </button>
        </div>
    </div>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="חפש תרגיל או סדרה..." oninput="handleSearch()">
    </div>
</header>

<main id="content"></main>

<div id="videoModal" class="modal" onclick="closeVideo()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeVideo()">&times;</span>
        <div class="video-container">
            <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let favorites = JSON.parse(localStorage.getItem('ijja_favs') || "[]");
    let isFavFilterActive = false;
    let allExpanded = false;

    // טעינת נתונים
    async function loadData() {
        try {
            const response = await fetch('Black_belt_syllabus_IJJA.csv');
            const csvText = await response.text();
            parseCSV(csvText);
            renderSyllabus();
        } catch (e) { console.error("Error loading CSV", e); }
    }

    function parseCSV(text) {
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const headers = lines[0].split(',');
        allData = lines.slice(1).map(line => {
            const values = line.split(',');
            return {
                category: values[0]?.trim(),
                series: values[1]?.trim(),
                id: values[2]?.trim(),
                name: values[3]?.trim(),
                link: values[4]?.trim()
            };
        });
    }

    function renderSyllabus() {
        const container = document.getElementById('content');
        container.innerHTML = '';

        const categories = [...new Set(allData.map(d => d.category))];

        categories.forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category-wrap';
            catDiv.innerHTML = `<div class="category-title">${cat}</div>`;

            const seriesInCat = [...new Set(allData.filter(d => d.category === cat).map(d => d.series))];

            seriesInCat.forEach(ser => {
                const serDiv = document.createElement('div');
                serDiv.className = 'series';
                serDiv.innerHTML = `
                    <div class="series-header" onclick="this.parentElement.classList.toggle('active'); this.nextElementSibling.classList.toggle('expanded')">
                        <span>${ser}</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="exercise-list"></div>
                `;

                const list = serDiv.querySelector('.exercise-list');
                const exercises = allData.filter(d => d.category === cat && d.series === ser);

                exercises.forEach(ex => {
                    const isFav = favorites.includes(ex.link);
                    const exDiv = document.createElement('div');
                    exDiv.className = 'exercise';
                    exDiv.innerHTML = `
                        <i class="fas fa-star fav-star ${isFav ? 'active' : ''}" onclick="toggleFav('${ex.link}', this)"></i>
                        <div class="exercise-name" onclick="openVideo('${ex.link}')">${ex.name}</div>
                        <i class="fab fa-youtube" style="color:#ff0000"></i>
                    `;
                    list.appendChild(exDiv);
                });

                catDiv.appendChild(serDiv);
            });
            container.appendChild(catDiv);
        });
    }

    function openVideo(url) {
        const embedUrl = url.replace("youtu.be/", "www.youtube.com/embed/").replace("watch?v=", "embed/");
        document.getElementById('videoFrame').src = embedUrl;
        document.getElementById('videoModal').style.display = 'flex';
    }

    function closeVideo() {
        document.getElementById('videoModal').style.display = 'none';
        document.getElementById('videoFrame').src = '';
    }

    function toggleFav(link, el) {
        if (favorites.includes(link)) {
            favorites = favorites.filter(f => f !== link);
            el.classList.remove('active');
        } else {
            favorites.push(link);
            el.classList.add('active');
        }
        localStorage.setItem('ijja_favs', JSON.stringify(favorites));
        if (isFavFilterActive) applyFavFilter();
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.exercise').forEach(ex => {
            const text = ex.innerText.toLowerCase();
            ex.classList.toggle('hidden', !text.includes(term));
        });

        document.querySelectorAll('.series').forEach(ser => {
            const hasVisible = ser.querySelectorAll('.exercise:not(.hidden)').length > 0;
            ser.classList.toggle('hidden', !hasVisible);
            if (term.length > 0 && hasVisible) {
                ser.classList.add('active');
                ser.querySelector('.exercise-list').classList.add('expanded');
            }
        });
    }

    function toggleFavFilter() {
        isFavFilterActive = !isFavFilterActive;
        document.getElementById('favFilterBtn').classList.toggle('active', isFavFilterActive);
        applyFavFilter();
    }

    function applyFavFilter() {
        document.querySelectorAll('.category-wrap').forEach(w => {
            const exercises = w.querySelectorAll('.exercise');
            let hasFavInCategory = false;

            exercises.forEach(ex => {
                const isFav = ex.querySelector('.fav-star').classList.contains('active');
                if (isFavFilterActive) {
                    ex.classList.toggle('hidden', !isFav);
                    if (isFav) hasFavInCategory = true;
                } else {
                    ex.classList.remove('hidden');
                }
            });

            document.querySelectorAll('.series').forEach(ser => {
                const hasVisible = ser.querySelectorAll('.exercise:not(.hidden)').length > 0;
                ser.classList.toggle('hidden', isFavFilterActive && !hasVisible);
            });

            w.classList.toggle('hidden', isFavFilterActive && !hasFavInCategory);
        });
    }

    function toggleAllAccordions() {
        allExpanded = !allExpanded;
        document.querySelectorAll('.series').forEach(s => s.classList.toggle('active', allExpanded));
        document.querySelectorAll('.exercise-list').forEach(l => l.classList.toggle('expanded', allExpanded));
        document.getElementById('toggleAllBtn').innerHTML = allExpanded ? '<i class="fas fa-arrows-alt-v"></i> סגור הכל' : '<i class="fas fa-arrows-alt-v"></i> פתח הכל';
    }

    function clearAllFavs() {
        if(confirm("למחוק את כל המועדפים?")) {
            favorites = [];
            localStorage.setItem('ijja_favs', "[]");
            document.querySelectorAll('.fav-star').forEach(s => s.classList.remove('active'));
            if(isFavFilterActive) applyFavFilter();
        }
    }

    // רישום Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js');
        });
    }

    loadData();
</script>

</body>
</html>
