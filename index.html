<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056a6">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black belt syllabus - v12.0.4</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* ××©×ª× ×™ ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™×™× */
        :root {
            --primary: #0056a6;   /* ×›×—×•×œ ××•×ª×’ ×¨××©×™ */
            --secondary: #009be5; /* ×›×—×•×œ ×‘×”×™×¨ ×œ××œ×× ×˜×™× ××©× ×™×™× */
            --border: #d2dce5;    /* ×¦×‘×¢ ×’×‘×•×œ×•×ª ×¢×“×™×Ÿ */
            --header-h: 90px;     /* ×’×•×‘×” ×§×‘×•×¢ ×œ×¨××© ×”×“×£ */
            --fav-color: #ffc107; /* ×¦×‘×¢ ×–×”×‘ ×œ×›×¤×ª×•×¨ ××•×¢×“×¤×™× */
            --danger: #d32f2f;    /* ××“×•× ×œ×”×ª×¨××•×ª/××—×™×§×” */
            --success: #2e7d32;   /* ×™×¨×•×§ ×œ××™×©×•×¨ ×¤×¢×•×œ×•×ª */
        }

        /* ×”×’×“×¨×•×ª ×‘×¡×™×¡ ×œ×× ×™×¢×ª ×’×œ×™×œ×” ×©×œ ×›×œ ×”×“×£ (×¢×‘×•×“×” ×›-App) */
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Heebo', sans-serif; 
            background: #f7f9fb; 
        }

        /* ×›×•×ª×¨×ª ×¢×œ×™×•× ×” ×§×‘×•×¢×” (Header) */
        header {
            height: var(--header-h); 
            background: white; 
            border-bottom: 3px solid var(--primary);
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 20px; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1200; 
            box-sizing: border-box;
        }

        .header-right { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 45px; width: auto; }
        header h1 { margin: 0; font-weight: 800; color: var(--primary); font-size: 1.1em; }

        /* ×¡×¨×’×œ ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” */
        .action-bar { display: flex; gap: 6px; }
        .btn {
            width: 38px; height: 38px; border-radius: 8px; border: 1px solid var(--border);
            background: white; color: var(--primary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1em;
        }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-danger { color: var(--danger); }

        /* ××œ×× ×˜ ×•×™×–×•××œ×™ ×œ×¨×¢× ×•×Ÿ ×‘××©×™×›×” (Pull to Refresh) */
        #ptr {
            position: absolute; top: var(--header-h); left: 0; width: 100%; height: 50px;
            display: flex; align-items: center; justify-content: center;
            transform: translateY(-100%); transition: transform 0.2s; z-index: 1000;
            color: var(--primary); font-weight: bold;
        }

        /* ××™×›×œ ×”×’×œ×™×œ×” ×”×¨××©×™ ×©×œ ×¨×©×™××ª ×”×ª×›× ×™× */
        #scrollContainer { 
            height: 100vh; 
            padding-top: var(--header-h); 
            overflow-y: auto; 
            box-sizing: border-box; 
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* "×”×¤×¡ ×”×œ×‘×Ÿ" - ××•× ×¢ ×–×œ×™×’×ª ×ª×•×›×Ÿ ××ª×—×ª ×œ-Header ×‘×–××Ÿ ×’×œ×™×œ×” */
        #scrollContainer::before {
            content: "";
            position: fixed;
            top: var(--header-h);
            left: 0;
            width: 100%;
            height: 10px;
            background: #f7f9fb;
            z-index: 1100;
        }

        .main-content { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 15px; 
            padding-bottom: 80px; 
            transition: transform 0.2s; 
        }
        
        /* ×›×•×ª×¨×ª ×§×˜×’×•×¨×™×” - × ×“×‘×§×ª ×œ×¨××© ×”×“×£ ×‘×’×œ×™×œ×” */
        .cat-group { margin-bottom: 25px; }
        .cat-header { 
            background: var(--primary); color: white; padding: 10px 15px; border-radius: 10px; 
            font-weight: 900; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ×©×•×¨×ª ×¡×“×¨×” (×œ×—×™×¦×” ×¤×•×ª×—×ª ×¨×©×™××ª ×ª×¨×’×™×œ×™×) */
        .ser-item { 
            background: white; padding: 12px; font-weight: 700; border-right: 4px solid var(--secondary); 
            margin-top: 8px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; border-radius: 6px; 
        }

        /* ×¨×©×™××ª ×ª×¨×’×™×œ×™× ×‘×ª×•×š ×¡×“×¨×” */
        .ex-list { list-style: none; padding: 0; margin: 0; display: none; background: white; border: 1px solid var(--border); }
        .ex-list.open { display: block; border-radius: 0 0 6px 6px; }
        .ex-row { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        .ex-link { color: var(--primary); font-weight: 600; text-decoration: underline; cursor: pointer; flex: 1; }
        .star { cursor: pointer; color: #ccc; font-size: 1.2rem; padding: 0 5px; }
        .star.active { color: var(--fav-color); }

        /* ××•×“××œ × ×’×Ÿ ×”×•×™×“×™××• */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; 
        }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 92%; max-width: 500px; position: relative; }
        
        /* ××™×›×œ ×”×¡×¨×˜×•×Ÿ - ×™×—×¡ 16:9 */
        .video-container { 
            position: relative; padding-bottom: 56.25%; height: 0; margin-top: 15px; 
            background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* ××¡×š ×›×™×¡×•×™ ×œ××¦×‘ "××‘×—×Ÿ ×¢×¦××™" */
        #videoCover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--secondary) 0%, var(--primary) 100%);
            color: white; z-index: 20; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; text-align: center;
            padding: 20px; box-sizing: border-box;
        }

        /* ×× ×™××¦×™×™×ª ×¤×¢×™××” ×œ×›×¤×ª×•×¨ ×”-Play ×‘×›×™×¡×•×™ */
        .play-trigger {
            width: 80px; height: 80px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; box-shadow: 0 0 20px rgba(255,255,255,0.4);
            animation: pulse 2s infinite;
        }
        .play-trigger i { color: var(--primary); font-size: 2.5rem; margin-right: -5px; }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(255,255,255,0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        .cover-text { font-weight: 900; font-size: 1.3em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×‘××•×“××œ */
        .close-btn { position: absolute; top: -45px; left: 0; color: white; font-size: 35px; cursor: pointer; }
        .modal-btn { 
            position: absolute; top: -45px; right: 0; width: 38px; height: 38px; border-radius: 8px; 
            border: 1px solid white; background: transparent; color: white; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 1.1em; 
        }
        .modal-btn.active { background: var(--success); border-color: var(--success); }

        .modal-nav { display: flex; justify-content: space-between; align-items: center; gap: 10px; text-align: center; }
        .nav-btn { 
            background: var(--primary); color: white; border: none; width: 35px; height: 35px; 
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .nav-btn:disabled { background: #eee !important; color: #bbb; }

        .hidden { display: none !important; }
        @media (max-width: 600px) {
        header h1 {
            font-size: 1rem;       /* ×”×§×˜× ×ª ×”×’×•×¤×Ÿ ××¢×˜ ×›×“×™ ×œ×× ×•×¢ ×©×‘×™×¨×” ××™×•×ª×¨×ª */
            line-height: 1.1;     /* ×©×œ×™×˜×” ×‘×¨×™×•×•×— - ×”×§×˜×Ÿ/×”×’×“×œ ×œ×¤×™ ×”×¦×•×¨×š */
            max-width: 180px;     /* ×”×’×‘×œ×ª ×¨×•×—×‘ ×›×“×™ ×©×”×˜×§×¡×˜ ×œ× ×™×™×¦××“ ×œ×©×•×œ×™×™× */
            display: block;
            }
        
        header { padding: 0 10px;      /* ×¦××¦×•× ×©×•×œ×™ ×”-header ×‘××•×‘×™×™×œ */
            }
        }
    </style>
</head>
<body>

<div id="ptr"><i class="fas fa-sync fa-spin"></i>&nbsp; ××¢×“×›×Ÿ × ×ª×•× ×™×...</div>

<header>
    <div class="header-right">
        <img src="Logo.png" alt="IJJA" class="logo-img">
        <div>
            <h1>×¡×™×œ×‘×•×¡ ×—×’×•×¨×” ×©×—×•×¨×”</h1>
            <small id="appVersion" style="color:#888">v12.0.4</small>
        </div>
    </div>
    <div class="action-bar">
        <button id="watchdogToggle" title="××¦×‘ Watchdog" class="btn active" onclick="toggleWatchdog()"><i class="fas fa-history"></i></button>
        <button title="×ª×¨×’×™×œ ××§×¨××™ (××‘×—×Ÿ)" class="btn" onclick="playRandom()"><i class="fas fa-random"></i></button>
        <button id="favFilterBtn" title="×¡×™× ×•×Ÿ ××•×¢×“×¤×™×" class="btn" onclick="toggleFavFilter()"><i class="fas fa-star"></i></button>
        <button title="×¤×ª×—/×¡×’×•×¨ ×”×›×œ" class="btn" onclick="toggleAll()"><i class="fas fa-arrows-alt-v"></i></button>
        <button title="××—×™×§×ª ××•×¢×“×¤×™×" class="btn btn-danger" onclick="clearFavs()"><i class="fas fa-trash-alt"></i></button>
    </div>
</header>

<div id="scrollContainer">
    <main class="main-content" id="app">
        </main>
</div>

<div id="vModal" class="modal" onclick="closeV()">
    <div class="modal-box" onclick="event.stopPropagation()">
        <i class="fas fa-times close-btn" onclick="closeV()"></i>
        <button id="vNextRandomBtn" title="××§×¨××™ ×”×‘×" class="modal-btn hidden" onclick="playRandom()"><i class="fas fa-random"></i></button>
        <button id="vAutoplayBtn" title="× ×™×’×•×Ÿ ×¨×¦×•×£" class="modal-btn hidden" onclick="toggleAutoplay()"><i class="fas fa-sync-alt"></i></button>
        
        <div class="modal-nav">
            <button id="prevBtn" class="nav-btn" onclick="nav(-1)"><i class="fas fa-chevron-right"></i></button>
            <div style="flex: 1; overflow: hidden; padding: 0 5px;">
                <div id="vPath" style="color:var(--secondary); font-weight:bold; font-size:0.85em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <div id="vName" style="color:var(--primary); font-size:1.1em; font-weight: 800; line-height:1.2;"></div>
                <div id="vCounter" style="font-size: 0.8em; color: #888; margin-top:2px;"></div>
            </div>
            <button id="nextBtn" class="nav-btn" onclick="nav(1)"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <div class="video-container">
            <div id="player"></div>
            <div id="videoCover" class="hidden" onclick="revealVideo()">
                <div class="play-trigger"><i class="fas fa-play"></i></div>
                <div class="cover-text">×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×‘×™×¦×•×¢ ×”×ª×¨×’×™×œ</div>
                <div style="margin-top:10px; font-size:0.9em; opacity:0.9;">××‘×—×Ÿ ×¢×¦××™</div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    /** ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× **/
    let prevWatchdogState = null;   // ×œ×©×—×–×•×¨ ××¦×‘ Watchdog
    let db = [], favs = [];
    
    // ×˜×¢×™× ×ª ××•×¢×“×¤×™× ××”×–×™×›×¨×•×Ÿ ×”××§×•××™
    try {
        favs = JSON.parse(localStorage.getItem('ijja_favs')) || [];
    } catch (e) {
        favs = [];
        localStorage.setItem('ijja_favs', "[]");
    }

    let isFavOnly = false, isRandomMode = false, isAutoplay = false, watchdogEnabled = true;
    let currentEx = null, ytPlayer = null, watchdogInterval = null, playerReady = false;
    let pendingVideoId = '', pendingStart = 0;

    /** Pull-to-Refresh: ×× ×’× ×•×Ÿ ×¢×“×›×•×Ÿ ×‘××©×™×›×” ×›×œ×¤×™ ××˜×” **/
    let startY = 0;
    const scrollContainer = document.getElementById('scrollContainer');
    const ptr = document.getElementById('ptr');
    const appMain = document.getElementById('app');

    scrollContainer.addEventListener('touchstart', e => { 
        if (scrollContainer.scrollTop === 0) startY = e.touches[0].pageY; 
    }, {passive: true});

    scrollContainer.addEventListener('touchmove', e => {
        const y = e.touches[0].pageY;
        if (scrollContainer.scrollTop === 0 && y > startY) {
            const diff = Math.min((y - startY) * 0.4, 60);
            ptr.style.transform = `translateY(${diff - 50}px)`;
            appMain.style.transform = `translateY(${diff}px)`;
        }
    }, {passive: true});

    scrollContainer.addEventListener('touchend', e => {
        const y = e.changedTouches[0].pageY;
        if (scrollContainer.scrollTop === 0 && y - startY > 120) location.reload();
        ptr.style.transform = 'translateY(-100%)'; 
        appMain.style.transform = 'translateY(0)';
    });

        // ğŸ”¹ ×©××™×¨×ª Scroll ×‘×–××Ÿ ×’×œ×™×œ×”
    scrollContainer.addEventListener('scroll', () => {
        localStorage.setItem('ijja_scroll', scrollContainer.scrollTop);
    });

    /** Service Worker PWA: ×¨×™×©×•× ×•× ×™×”×•×œ ×’×¨×¡××•×ª ××¤×œ×™×§×¦×™×” **/
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
        navigator.serviceWorker.ready.then(reg => {
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        if (confirm("×’×¨×¡×” ×—×“×©×” ×–××™× ×”! ×”×× ×œ×¢×“×›×Ÿ ×›×¢×ª?")) location.reload();
                    }
                });
            });
        });
    }

    // ×˜×¢×™× ×ª ×’×¨×¡×” ××§×•×‘×¥ ×—×™×¦×•× ×™
    async function loadVersion() {
        try {
            const r = await fetch('version.json', { cache: 'no-store' });
            const v = await r.json();
            document.getElementById('appVersion').innerText = 'v' + v.version;
            return v.version;
        } catch (e) {
            console.warn('version.json not loaded');
            return null;
        }
    }
        
    /** ×œ×•×’×™×§×ª × ×™×•×•×˜: ×§×‘×œ×ª ×”×ª×¨×’×™×œ ×”×‘× ×¢×‘×•×¨ Autoplay **/
    function getNextExercise() {
        if (!currentEx) return null;
        let list = [];
        if(isFavOnly) {
            list = db.filter(x => favs.includes(x.id));
        } else {
            list = db.filter(x => x.cat === currentEx.cat && x.ser === currentEx.ser);
        }
        const idx = list.findIndex(x => x.id === currentEx.id);
        if(idx < 0 || idx + 1 >= list.length) return null;
        return list[idx + 1];
    }
        
    /** YouTube Player: ××ª×—×•×œ ×”× ×’×Ÿ **/
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { 'modestbranding': 1, 'rel': 0, 'playsinline': 1 },
            events: { 
                'onReady': () => { 
                    playerReady = true;
                    if (pendingVideoId) {
                        ytPlayer.cueVideoById({
                            videoId: pendingVideoId,
                            startSeconds: pendingStart
                        });
                        
                        setTimeout(() => {
                            if (ytPlayer && typeof ytPlayer.playVideo === 'function') {
                                ytPlayer.playVideo();
                            }
                        }, 0);

                    }
                },
                'onStateChange': onPlayerStateChange
            }
        });
    }

    /** × ×™×”×•×œ ××¦×‘×™ × ×’×Ÿ **/
    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            if (watchdogEnabled) startWatchdog();
        }

        if (event.data === YT.PlayerState.ENDED) {
            stopWatchdog();
            // ××¢×‘×¨ ××•×˜×•××˜×™ ×‘×¡×™×•× ×¡×¨×˜×•×Ÿ
            if (!watchdogEnabled && isAutoplay && isFavOnly) {
                const list = getCurrentListFull();
                const idx = list.findIndex(x => x.id === currentEx.id);
                if (list[idx + 1]) openV(list[idx + 1]);
                else if (list.length) openV(list[0]);
            }
        }

        if(event.data === YT.PlayerState.PAUSED) stopWatchdog();
    }

    /** Watchdog: ×× ×’× ×•×Ÿ ×”×’×‘×œ×ª ×–××Ÿ × ×™×’×•×Ÿ ×•×—×–×¨×” ×œ×”×ª×—×œ×” **/
    function startWatchdog() {
        stopWatchdog();
        if (!watchdogEnabled || !currentEx || currentEx.duration <= 0 || !pendingVideoId) return;
        const start = getStartTime(currentEx.embed || currentEx.link);

        watchdogInterval = setInterval(() => {
            if (!ytPlayer) return;
            if (ytPlayer.getCurrentTime() - start >= currentEx.duration) {
                stopWatchdog();
                if (isAutoplay && isFavOnly) {
                    const list = getCurrentListFull();
                    const idx = list.findIndex(x => x.id === currentEx.id);
                    if (list[idx + 1]) openV(list[idx + 1]);
                    else if (list.length) openV(list[0]);
                } else {
                    ytPlayer.pauseVideo();
                    ytPlayer.seekTo(start);
                }
            }
        }, 400);
    }

    function stopWatchdog() { clearInterval(watchdogInterval); }

    function toggleWatchdog() {
        watchdogEnabled = !watchdogEnabled;
        document.getElementById('watchdogToggle').classList.toggle('active', watchdogEnabled);
    }

    /** Autoplay: ××¦×‘ × ×™×’×•×Ÿ ×¨×¦×•×£ **/
    function toggleAutoplay() {
        if (!isFavOnly) return; // ××•×ª×¨ ×¨×§ ×‘××•×¢×“×¤×™×
        isAutoplay = !isAutoplay;
        if (isAutoplay) {
            prevWatchdogState = watchdogEnabled;
            watchdogEnabled = true;
            document.getElementById('watchdogToggle').classList.toggle('active', true);
            if (currentEx && ytPlayer && playerReady) revealVideo();
        } else {
            if (prevWatchdogState !== null) {
                watchdogEnabled = prevWatchdogState;
                document.getElementById('watchdogToggle').classList.toggle('active', watchdogEnabled);
            }
        }
        updateModalLayout();
    }

    /** ×˜×¢×™× ×ª × ×ª×•× ×™× ×¨××©×•× ×™×ª ××”-CSV **/
    async function init() {
        try {
            const r = await fetch('Black_belt_syllabus_IJJA.csv', { cache: 'no-cache' });
            const txt = await r.text();
            db = parseCSV(txt);
            render();
        } catch (e) {
            console.error("CSV Load Fail", e);
            document.getElementById('app').innerHTML =
            '<div style="color:#d32f2f; font-weight:bold; padding:20px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜.</div>';
        }
    }

     function restoreState() {
        // 1. Scroll
        const scrollTop = parseInt(localStorage.getItem('ijja_scroll'));
        if(scrollTop) scrollContainer.scrollTop = scrollTop;
    
        // 2. ×¡×“×¨×•×ª ×¤×ª×•×—×•×ª
        const openSeries = JSON.parse(localStorage.getItem('ijja_openSeries') || '[]');
        document.querySelectorAll('.ser-item').forEach(s=>{
            const list = s.nextElementSibling;
            const cat = s.parentElement.querySelector('.cat-header').innerText;
            const ser = s.querySelector('span').innerText;
            if(openSeries.includes(cat + '||' + ser)) {
                list.classList.add('open');
                const icon = s.querySelector('i.fas');
                if(icon) icon.className='fas fa-chevron-up';
            }
        });
    
        // 3. ×¤×™×œ×˜×¨ ××•×¢×“×¤×™×
        const favState = localStorage.getItem('ijja_isFavOnly');
        if(favState==='1') {
            isFavOnly = true;
            document.getElementById('favFilterBtn').classList.add('active');
            applyFilters();
        }
    }
    
    // ×‘×¡×•×£ init()
    window.onload = async function() {
        await init();
        restoreState();
    }
   

    /** × ×™×ª×•×— ××‘× ×” ×”-CSV **/
    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        const results = [];
        const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; // ×”×ª×¢×œ××•×ª ××¤×¡×™×§×™× ×‘×ª×•×š ×’×¨×©×™×™×
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(regex).map(c => c.replace(/^"|"$/g,'').trim());
            if (cols.length < 7) continue;
            results.push({
                id: i-1, cat: cols[0], ser: cols[1], num: cols[2], name: cols[3],
                link: cols[4], embed: cols[5], duration: Number(cols[6]) || 0
            });
        }
        return results;
    }

    /** ×‘× ×™×™×ª ×××©×§ ×”××©×ª××© (DOM Rendering) **/
    function render() {
        const app = document.getElementById('app'); 
        app.innerHTML = '';
        
        // ×§×™×‘×•×¥ × ×ª×•× ×™× ×œ×¤×™ ×§×˜×’×•×¨×™×” ×•×¡×“×¨×”
        const groups = db.reduce((acc, x) => {
            if(!acc[x.cat]) acc[x.cat] = {};
            if(!acc[x.cat][x.ser]) acc[x.cat][x.ser] = [];
            acc[x.cat][x.ser].push(x);
            return acc;
        }, {});

        for(let cat in groups) {
            const cDiv = document.createElement('div'); 
            cDiv.className='cat-group';
            cDiv.innerHTML = `<div class="cat-header">${cat}</div>`;
            
            for(let ser in groups[cat]) {
                const exercises = groups[cat][ser];
                const sBtn = document.createElement('div'); 
                sBtn.className='ser-item';
                sBtn.innerHTML = `
                    <div style="flex:1" onclick="toggleSerList(this)">
                        <i class="fas fa-chevron-down" style="margin-left:8px"></i>
                        <span>${ser}</span>
                    </div>
                    <i class="fas fa-star star ${exercises.every(ex=>favs.includes(ex.id))?'active':''}" 
                       onclick="toggleSeriesFav(this,'${cat}','${ser}')"></i>`;
                
                const list = document.createElement('ul'); 
                list.className='ex-list';
                
                exercises.forEach(ex=>{
                    const li = document.createElement('li'); 
                    li.className='ex-row'; 
                    li.dataset.id=ex.id;
                    const hasL = (ex.link+ex.embed).length>10;
                    li.innerHTML = `
                        <span class="${hasL?'ex-link':'ex-no-link'}" 
                              onclick="${hasL?`openVById(${ex.id},false)` : ''}">
                              ${ex.num}. ${ex.name}</span>
                        <i class="fas fa-star star ${favs.includes(ex.id)?'active':''}" 
                           onclick="toggleStar(${ex.id},this)"></i>`;
                    list.appendChild(li);
                });
                cDiv.appendChild(sBtn); 
                cDiv.appendChild(list);
            }
            app.appendChild(cDiv);
        }
        if(isFavOnly) applyFilters();

        if(scrollContainer && localStorage.getItem('ijja_scroll')) {
            scrollContainer.scrollTop = parseInt(localStorage.getItem('ijja_scroll')) || 0;
}

    }

    /** ×¤×ª×™×—×ª ×¡×¨×˜×•×Ÿ ×œ×¤×™ ××–×”×” **/
    function openVById(id, isRand) { 
        isRandomMode=isRand; 
        const ex=db.find(x=>x.id===id); 
        if(ex) openV(ex); 
    }

function updateModalLayout() {
    const autoBtn = document.getElementById('vAutoplayBtn');
    const nextRandBtn = document.getElementById('vNextRandomBtn');
    const pBtn = document.getElementById('prevBtn');
    const nBtn = document.getElementById('nextBtn');
    const cnt = document.getElementById('vCounter');

    // ×©×œ×‘ 1: ×”×¡×ª×¨×” ×’×•×¨×¤×ª ×©×œ ×›×œ ×›×¤×ª×•×¨×™ ×”×‘×§×¨×”
    [autoBtn, nextRandBtn, pBtn, nBtn].forEach(b => {
        if(b) b.classList.add('hidden');
    });

    if (isRandomMode) { 
        // ××¦×‘ ××‘×—×Ÿ ×¢×¦××™: ××¦×™×’ ×¨×§ ×›×¤×ª×•×¨ "××§×¨××™ ×”×‘×"
        if(nextRandBtn) nextRandBtn.classList.remove('hidden'); 
        if(cnt) cnt.innerText = "××¦×‘ ××‘×—×Ÿ ×¢×¦××™"; 
    } else {
        // ××¦×‘ ×¨×’×™×œ/××•×¢×“×¤×™×: ××¦×™×’ × ×™×•×•×˜ ×•× ×’×Ÿ ×¨×¦×•×£
        let list = getCurrentListFull();
        let idx = list.findIndex(x => x.id === currentEx.id);
        
        if (isFavOnly && autoBtn) autoBtn.classList.remove('hidden');
        if (pBtn) {
            pBtn.classList.remove('hidden');
            pBtn.disabled = idx <= 0;
        }
        if (nBtn) {
            nBtn.classList.remove('hidden');
            nBtn.disabled = idx >= list.length - 1;
        }
        if (cnt) cnt.innerText = `${isFavOnly ? '××•×¢×“×£' : '×ª×¨×’×™×œ'} ${idx + 1} ××ª×•×š ${list.length}`;
    }
    
    // ×¢×“×›×•×Ÿ ××¦×‘ ×•×™×–×•××œ×™ ×œ×›×¤×ª×•×¨ ×”-Autoplay
    if(autoBtn) autoBtn.classList.toggle('active', isAutoplay);
}

    
function openV(ex) {
    currentEx = ex;
    document.getElementById('vPath').innerText = `${ex.cat} > ${ex.ser}`;
    document.getElementById('vName').innerText = ex.name;
    document.getElementById('vModal').style.display = 'flex';
    updateModalLayout();

    const url = ex.embed || ex.link;

    function extractVideoId(url){
        if(!url) return '';
        let id = '';
        if(url.includes('v=')) id = url.split('v=')[1].split('&')[0];
        else if(url.includes('embed/')) id = url.split('embed/')[1].split('?')[0];
        else if(url.includes('youtu.be/')) id = url.split('youtu.be/')[1].split('?')[0];
        return decodeURIComponent(id.trim());
    }

    pendingVideoId = extractVideoId(url);
    pendingStart = getStartTime(url);

    const cover = document.getElementById('videoCover');

    if (isRandomMode) {
        cover.classList.remove('hidden');
        if (ytPlayer && playerReady) ytPlayer.stopVideo();
    } else {
        cover.classList.add('hidden');
        // âœ… ×ª××™×“ ×˜×¢×Ÿ ××—×“×© ××ª ×”×¡×¨×˜×•×Ÿ
        if (ytPlayer && playerReady && pendingVideoId) {
            // ğŸ›¡ï¸ Reset ×‘×˜×•×— ×œ×× ×™×¢×ª race condition
            ytPlayer.stopVideo();
        
            // ×“×—×™×™×” ×§×¦×¨×” â€“ ×××¤×©×¨×ª ×œÖ¾YT ×œ×¦××ª ×××¦×‘ ×‘×™× ×™×™×
            setTimeout(() => {
                ytPlayer.loadVideoById({
                    videoId: pendingVideoId,
                    startSeconds: pendingStart
                });
            }, 80);
        }

    }
}

    /** ×—×™×œ×•×¥ ×–××Ÿ ×”×ª×—×œ×” ×-URL **/
    function getStartTime(url){ 
        const m=url.match(/[?&](t|start)=([0-9]+)/); 
        return m?parseInt(m[2]):0; 
    }

    /** ×”×¦×’×ª ×”×•×™×“××• ×‘××¦×‘ ××‘×—×Ÿ ×¢×¦××™ **/
    function revealVideo() {
        const cover = document.getElementById('videoCover');
        cover.classList.add('hidden');
        if (!ytPlayer || !playerReady || !pendingVideoId) return;
        const state = ytPlayer.getPlayerState();
        if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED) {
            ytPlayer.playVideo();
        } else {
            ytPlayer.loadVideoById({
                videoId: pendingVideoId,
                startSeconds: pendingStart
            });
        }
    }

    /** ×¢×“×›×•×Ÿ × ×¨××•×ª ×›×¤×ª×•×¨×™× ×‘××•×“××œ **/
    function updateModalLayout() {
        const autoBtn=document.getElementById('vAutoplayBtn');
        const nextRandBtn=document.getElementById('vNextRandomBtn');
        const pBtn=document.getElementById('prevBtn');
        const nBtn=document.getElementById('nextBtn');
        const cnt=document.getElementById('vCounter');
        [autoBtn,nextRandBtn,pBtn,nBtn].forEach(b=>b.classList.add('hidden'));

        if(isRandomMode) { 
            nextRandBtn.classList.remove('hidden'); 
            cnt.innerText="××¦×‘ ××‘×—×Ÿ ×¢×¦××™"; 
        } else {
            let list = getCurrentListFull();
            let idx = list.findIndex(x => x.id === currentEx.id);
            if(isFavOnly) autoBtn.classList.remove('hidden');
            pBtn.classList.remove('hidden'); 
            nBtn.classList.remove('hidden');
            pBtn.disabled = idx<=0; 
            nBtn.disabled=idx>=list.length-1;
            cnt.innerText=`${isFavOnly?'××•×¢×“×£':'×ª×¨×’×™×œ'} ${idx+1} ××ª×•×š ${list.length}`;
        }
        autoBtn.classList.toggle('active',isAutoplay);
    }

    /** ×§×‘×œ×ª ×”×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª ×œ× ×™×•×•×˜ **/
    function getCurrentListFull() {
        if (!currentEx) return [];
        if (isFavOnly) {
            return db.filter(x => favs.includes(x.id));
        } else {
            return db.filter(x => x.cat === currentEx.cat && x.ser === currentEx.ser);
        }
    }
        
    /** × ×™×•×•×˜ ×‘×™×Ÿ ×ª×¨×’×™×œ×™× (×§×“×™××”/××—×•×¨×”) **/
function nav(dir) {
    if(isRandomMode) return;
    const list = getCurrentListFull();
    const idx = list.findIndex(x => x.id === currentEx.id);
    if(idx === -1) return; // ×œ× × ××¦× ×‘×¨×©×™××”, ×¢×¦×•×¨

    if(list[idx + dir]) {
        openV(list[idx + dir]);
        
        // ×”×©×•×¨×” ×©×—×•×‘×” ×œ×”×•×¡×™×£ ×›×“×™ ×œ×¢×“×›×Ÿ ××ª ×”×›×¤×ª×•×¨×™× ×•×”××•× ×” ×‘××¢×‘×¨
        if (typeof updateModalLayout === "function") {
            updateModalLayout();
        }
    } else {
        closeV();
    }
}

    /** ×¡×’×™×¨×ª ××•×“××œ **/
    function closeV() { 
        document.getElementById('vModal').style.display='none'; 
        if(ytPlayer) ytPlayer.stopVideo(); 
        stopWatchdog(); 
        isRandomMode=false; 
    }

    /** ×¤×ª×™×—×ª/×¡×’×™×¨×ª ×¨×©×™××ª ×¡×“×¨×•×ª **/
    function toggleSerList(el){ 
        const list=el.parentElement.nextElementSibling; 
        const open=list.classList.toggle('open'); 
        el.querySelector('i').className=open?'fas fa-chevron-up':'fas fa-chevron-down'; 
    
        // ×©××™×¨×” ×œ××§×•××™
        saveOpenSeries();
    }

// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×©××™×¨×”
function saveOpenSeries() {
    const openSeries = [];
    document.querySelectorAll('.ser-item').forEach(s=>{
        const list = s.nextElementSibling;
        if(list.classList.contains('open')) {
            const cat = s.parentElement.querySelector('.cat-header').innerText;
            const ser = s.querySelector('span').innerText;
            openSeries.push(cat + '||' + ser);
        }
    });
    localStorage.setItem('ijja_openSeries', JSON.stringify(openSeries));
}


    /** × ×™×”×•×œ ××•×¢×“×¤×™× (×›×•×›×‘×™×) **/
    function toggleStar(id,el){ 
        if(favs.includes(id)) favs=favs.filter(f=>f!==id); 
        else favs.push(id); 
        el.classList.toggle('active'); 
        localStorage.setItem('ijja_favs',JSON.stringify(favs)); 
        if(isFavOnly) applyFilters(); 
    }

    function toggleSeriesFav(el,cat,ser){ 
        const exs=db.filter(x=>x.cat===cat && x.ser===ser);
        const all=exs.every(ex=>favs.includes(ex.id));
        if(all){ 
            const ids=exs.map(x=>x.id); 
            favs=favs.filter(id=>!ids.includes(id)); 
        } else { 
            exs.forEach(ex=>{ if(!favs.includes(ex.id)) favs.push(ex.id); }); 
        }
        localStorage.setItem('ijja_favs',JSON.stringify(favs)); 
        render();
    }
        
    function clearFavs(){ 
        if(confirm("×œ××—×•×§ ××ª ×›×œ ×”××•×¢×“×¤×™×?")){ 
            favs=[]; 
            localStorage.setItem('ijja_favs',"[]");
            isFavOnly=false; 
            document.getElementById('favFilterBtn').classList.remove('active');
            render();
        }
    }

    /** ×¤×™×œ×˜×¨ ××•×¢×“×¤×™× **/
    function toggleFavFilter(){ 
        isFavOnly=!isFavOnly; 
        document.getElementById('favFilterBtn').classList.toggle('active',isFavOnly); 
        applyFilters(); 
    
        // ×©××™×¨×” ×œ××§×•××™
        saveFavFilter();
    }
    
    // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×©××™×¨×”
    function saveFavFilter() {
        localStorage.setItem('ijja_isFavOnly', isFavOnly ? '1' : '0');
    }

    function applyFilters(){
        document.querySelectorAll('.cat-group').forEach(c=>{
            let catHasVisible=false;
            c.querySelectorAll('.ser-item').forEach(s=>{
                let serHasVisible=false; 
                const list=s.nextElementSibling;
                list.querySelectorAll('.ex-row').forEach(row=>{
                    const id=parseInt(row.dataset.id);
                    const hide=isFavOnly && !favs.includes(id);
                    row.classList.toggle('hidden',hide);
                    if(!hide) serHasVisible=true;
                });
                s.classList.toggle('hidden',isFavOnly && !serHasVisible);
                list.classList.toggle('hidden',isFavOnly && !serHasVisible);
                if(serHasVisible) catHasVisible=true;
            });
            c.classList.toggle('hidden',isFavOnly && !catHasVisible);
        });
    }

    /** ×¤×ª×™×—×ª/×¡×’×™×¨×ª ×›×œ ×”×¡×“×¨×•×ª ×‘×œ×—×™×¦×” ××—×ª **/
    function toggleAll(){
        const anyClosed=Array.from(document.querySelectorAll('.ex-list:not(.hidden)')).some(l=>!l.classList.contains('open'));
        document.querySelectorAll('.ex-list').forEach(l=>{
            if(!l.classList.contains('hidden')){
                l.classList.toggle('open',anyClosed);
                const icon=l.previousElementSibling.querySelector('i.fas');
                if(icon) icon.className=anyClosed?'fas fa-chevron-up':'fas fa-chevron-down';
            }
        });
    
        // ×©××™×¨×” ×œ××§×•××™
        saveOpenSeries();
    }

    /** ×”×¤×¢×œ×ª ×ª×¨×’×™×œ ××§×¨××™ **/
    function playRandom(){
        const pool=db.filter(x=>(x.link+x.embed).length>10);
        if(pool.length) openVById(pool[Math.floor(Math.random()*pool.length)].id,true);
    }

</script>
</body>
</html>








