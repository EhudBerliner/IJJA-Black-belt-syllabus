<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056a6">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Syllabus IJJA - v2.2.5</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056a6;
            --secondary: #009be5;
            --border: #d2dce5;
            --header-h: 90px;
            --fav-color: #ffc107;
            --bg: #f7f9fb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Heebo', sans-serif;
            margin: 0; background: var(--bg); color: #333;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header */
        header {
            height: var(--header-h); background: #fff;
            padding: 10px 15px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-area img { height: 50px; }
        .logo-area h1 { font-size: 1.2rem; margin: 0; color: var(--primary); font-weight: 900; }

        /* Controls */
        .controls {
            padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; gap: 8px; overflow-x: auto; white-space: nowrap;
        }
        button {
            padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border);
            background: #fff; font-family: inherit; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        button.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .search-box { position: relative; flex-grow: 1; min-width: 150px; }
        .search-box input {
            width: 100%; padding: 8px 30px 8px 10px; border-radius: 20px;
            border: 1px solid var(--border); outline: none;
        }
        .search-box i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; }

        /* List Area */
        #scrollContainer { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .category-group { margin-bottom: 20px; }
        .category-title {
            background: var(--primary); color: #fff; padding: 10px 15px;
            border-radius: 8px; font-weight: 900; margin-bottom: 5px;
        }
        .series-item { background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 4px; }
        .series-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .series-header h3 { margin: 0; font-size: 1rem; }
        .ex-list { display: none; padding: 0 10px 10px; }
        .ex-list.open { display: block; }
        .ex-row {
            display: flex; align-items: center; padding: 10px; border-top: 1px solid #eee; gap: 10px;
        }
        .ex-info { flex-grow: 1; font-weight: 400; font-size: 0.95rem; }
        .btn-play { color: var(--primary); font-size: 1.2rem; }
        .btn-fav { color: #ccc; font-size: 1.2rem; }
        .btn-fav.active { color: var(--fav-color); }

        /* Modal */
        #vModal {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: none; flex-direction: column;
        }
        .modal-header {
            padding: 15px; color: #fff; display: flex; justify-content: space-between; align-items: center;
        }
        #video-container { flex-grow: 1; position: relative; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        #videoCover {
            position: absolute; inset: 0; background: #111; color: #fff;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; z-index: 5;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="Logo.png" alt="IJJA">
        <h1>סילבוס חגורה שחורה</h1>
    </div>
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="חיפוש תרגיל..." oninput="applyFilters()">
    </div>
</header>

<div class="controls">
    <button id="btnFavOnly" onclick="toggleFavFilter()">
        <i class="fas fa-star"></i> מועדפים
    </button>
    <button onclick="toggleAll()">
        <i class="fas fa-layer-group"></i> הרחב הכל
    </button>
    <button onclick="playRandom()" class="active" style="background: #e91e63; border-color: #e91e63; color: #fff;">
        <i class="fas fa-dice"></i> מצב מבחן
    </button>
</div>

<div id="scrollContainer">
    </div>

<div id="vModal">
    <div class="modal-header">
        <h3 id="modalTitle" style="margin:0">שם התרגיל</h3>
        <button onclick="closeModal()" style="background:none; border:none; color:#fff; font-size:1.5rem;">&times;</button>
    </div>
    <div id="video-container">
        <div id="videoCover" onclick="revealVideo()">
            <i class="fas fa-question-circle" style="font-size: 4rem; margin-bottom: 15px;"></i>
            <h2>בצע את התרגיל!</h2>
            <p>לחץ כאן לצפייה בפתרון</p>
        </div>
        <div id="player"></div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let db = [];
    let favorites = [];
    let isFavOnly = false;
    let isRandomMode = false;
    let player;
    let watchdogTimer;
    let currentEx = null;

    // אתחול
    async function init() {
        try {
            // טעינת מועדפים בצורה בטוחה
            const saved = localStorage.getItem('ijja_favs');
            favorites = saved ? JSON.parse(saved) : [];
            
            const res = await fetch('Black_belt_syllabus_IJJA.csv');
            const csvText = await res.text();
            db = parseCSV(csvText);
            renderList();
        } catch (e) { console.error("Init error:", e); }
    }

    // פונקציית CSV עמידה לפסיקים בתוך מירכאות
    function parseCSV(data) {
        const rows = data.split(/\r?\n/).filter(r => r.trim());
        const result = [];
        const headers = rows[0].split(',');

        for (let i = 1; i < rows.length; i++) {
            // Regex להתמודדות עם פסיקים בתוך מירכאות
            const matches = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (matches) {
                const cols = matches.map(c => c.replace(/^"|"$/g, ''));
                result.push({
                    id: i,
                    category: cols[0],
                    series: cols[1],
                    num: cols[2],
                    name: cols[3],
                    link: cols[4],
                    embed: cols[5],
                    duration: parseInt(cols[6]) || 10
                });
            }
        }
        return result;
    }

    function renderList() {
        const container = document.getElementById('scrollContainer');
        const cats = [...new Set(db.map(x => x.category))];
        
        let html = '';
        cats.forEach(cat => {
            html += `<div class="category-group" data-cat="${cat}">
                <div class="category-title">${cat}</div>`;
            
            const series = [...new Set(db.filter(x => x.category === cat).map(x => x.series))];
            series.forEach(ser => {
                html += `<div class="series-item" data-ser="${ser}">
                    <div class="series-header" onclick="toggleSeries(this)">
                        <h3>${ser}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="ex-list">`;
                
                db.filter(x => x.category === cat && x.series === ser).forEach(ex => {
                    const isFav = favorites.includes(ex.id) ? 'active' : '';
                    html += `
                        <div class="ex-row" data-id="${ex.id}" data-name="${ex.name}">
                            <div class="ex-info">${ex.num}. ${ex.name}</div>
                            <i class="fas fa-star btn-fav ${isFav}" onclick="toggleFav(event, ${ex.id})"></i>
                            <i class="fas fa-play-circle btn-play" onclick="openVideo(${ex.id})"></i>
                        </div>`;
                });
                html += `</div></div>`;
            });
            html += `</div>`;
        });
        container.innerHTML = html;
    }

    // ניהול מועדפים
    function toggleFav(e, id) {
        e.stopPropagation();
        const idx = favorites.indexOf(id);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(id);
        
        localStorage.setItem('ijja_favs', JSON.stringify(favorites));
        e.target.classList.toggle('active');
        if(isFavOnly) applyFilters();
    }

    function toggleFavFilter() {
        isFavOnly = !isFavOnly;
        document.getElementById('btnFavOnly').classList.toggle('active', isFavOnly);
        applyFilters();
    }

    // סינון היררכי ותקין
    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        
        document.querySelectorAll('.category-group').forEach(catEl => {
            let catVisible = false;
            
            catEl.querySelectorAll('.series-item').forEach(serEl => {
                let serVisible = false;
                
                serEl.querySelectorAll('.ex-row').forEach(exEl => {
                    const id = parseInt(exEl.dataset.id);
                    const name = exEl.dataset.name.toLowerCase();
                    const matchesSearch = name.includes(q);
                    const matchesFav = !isFavOnly || favorites.includes(id);
                    
                    const show = matchesSearch && matchesFav;
                    exEl.classList.toggle('hidden', !show);
                    if (show) serVisible = true;
                });
                
                serEl.classList.toggle('hidden', !serVisible);
                if (serVisible) catVisible = true;
            });
            
            catEl.classList.toggle('hidden', !catVisible);
        });
    }

    function toggleSeries(el) {
        const list = el.nextElementSibling;
        const icon = el.querySelector('i');
        list.classList.toggle('open');
        icon.className = list.classList.contains('open') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    }

    function toggleAll() {
        const lists = document.querySelectorAll('.ex-list');
        const anyClosed = Array.from(lists).some(l => !l.classList.contains('open'));
        lists.forEach(l => {
            l.classList.toggle('open', anyClosed);
            const icon = l.previousElementSibling.querySelector('i');
            icon.className = anyClosed ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        });
    }

    // וידאו ונגן
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 1, 'modestbranding': 1, 'rel': 0 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function openVideo(id, random = false) {
        currentEx = db.find(x => x.id === id);
        if(!currentEx) return;

        isRandomMode = random;
        document.getElementById('modalTitle').innerText = isRandomMode ? "מצב מבחן" : currentEx.name;
        document.getElementById('vModal').style.display = 'flex';
        document.getElementById('videoCover').style.display = isRandomMode ? 'flex' : 'none';

        const videoId = extractVideoId(currentEx.embed);
        const startSec = extractStartParam(currentEx.embed);

        if (player && player.loadVideoById) {
            player.loadVideoById({
                videoId: videoId,
                startSeconds: startSec
            });
        }
        
        if (isRandomMode) {
            setTimeout(() => { if(player.pauseVideo) player.pauseVideo(); }, 500);
        } else {
            startWatchdog(startSec, currentEx.duration);
        }
    }

    function revealVideo() {
        document.getElementById('videoCover').style.display = 'none';
        document.getElementById('modalTitle').innerText = currentEx.name;
        player.playVideo();
        const startSec = extractStartParam(currentEx.embed);
        startWatchdog(startSec, currentEx.duration);
    }

    function startWatchdog(start, duration) {
        clearInterval(watchdogTimer);
        watchdogTimer = setInterval(() => {
            if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
                const now = player.getCurrentTime();
                if (now >= (start + duration)) {
                    // אם במועדפים בלבד - עבור לבא. אחרת - לופ.
                    if (isFavOnly && !isRandomMode) {
                        playNextFavorite();
                    } else {
                        player.seekTo(start);
                    }
                }
            }
        }, 500);
    }

    function playNextFavorite() {
        const currentIdx = favorites.indexOf(currentEx.id);
        if (currentIdx > -1 && currentIdx < favorites.length - 1) {
            openVideo(favorites[currentIdx + 1]);
        } else {
            closeModal();
        }
    }

    function playRandom() {
        // בחירה מתוך המאגר המסונן (אם מסונן למועדפים - יבחר רק מהם)
        const pool = db.filter(x => !isFavOnly || favorites.includes(x.id));
        if (pool.length === 0) return alert("אין תרגילים לבחירה");
        const rnd = pool[Math.floor(Math.random() * pool.length)];
        openVideo(rnd.id, true);
    }

    function closeModal() {
        clearInterval(watchdogTimer);
        if(player && player.stopVideo) player.stopVideo();
        document.getElementById('vModal').style.display = 'none';
    }

    function onPlayerStateChange(event) {
        // בקרות נוספות אם נדרש
    }

    function extractVideoId(url) {
        const m = url.match(/\/embed\/([^?]+)/);
        return m ? m[1] : '';
    }

    function extractStartParam(url) {
        const m = url.match(/start=(\d+)/);
        return m ? parseInt(m[1]) : 0;
    }

    window.onload = init;
</script>
</body>
</html>
