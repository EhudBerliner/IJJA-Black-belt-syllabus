<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056a6">
    <link rel="apple-touch-icon" href="Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black belt Syllabus - v2.2.4</title>

    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056a6;   /* כחול מותג ראשי */
            --secondary: #009be5; /* כחול בהיר לאלמנטים משניים */
            --border: #d2dce5;    /* צבע גבולות עדין */
            --header-h: 90px;     /* גובה קבוע לראש הדף */
            --fav-color: #ffc107; /* צבע זהב למועדפים */
            --danger: #d32f2f;    /* אדום לטיימר */
        }

        /* הגדרות בסיס למבנה הדף */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: 'Heebo', sans-serif; 
            background: #f7f9fb; 
            color: #333;
        }

        /* ראש הדף - קבוע למעלה */
        header { 
            height: var(--header-h); 
            background: white; 
            border-bottom: 3px solid var(--primary); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            box-sizing: border-box; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo-img { height: 45px; cursor: pointer; transition: transform 0.2s; }
        .logo-img:active { transform: scale(0.95); }

        /* אזור הגלילה הראשי */
        #scrollContainer { 
            height: 100vh; 
            padding-top: var(--header-h); 
            overflow-y: auto; 
            box-sizing: border-box; 
            -webkit-overflow-scrolling: touch; 
        }

        .main-content { max-width: 800px; margin: 0 auto; padding: 15px; padding-bottom: 120px; }

        /* סרגל כלים עליון */
        .toolbar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            position: sticky; 
            top: 0; 
            background: #f7f9fb; 
            padding: 5px 0; 
            z-index: 10;
        }
        .btn-tool { 
            background: white; 
            border: 1px solid var(--border); 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.85em; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            color: #555;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .btn-tool.active { background: var(--fav-color); color: black; border-color: #e0ac00; }
        .btn-tool i { font-size: 1.1em; }

        /* עיצוב רשימת התרגילים (קטגוריה וסדרה) */
        .cat-group { margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-group.hidden { display: none; }
        .cat-header { background: var(--primary); color: white; padding: 12px 15px; font-weight: 900; font-size: 1.1em; letter-spacing: 0.5px; }
        
        .ser-item { border-bottom: 1px solid var(--border); }
        .ser-item:last-child { border-bottom: none; }
        .ser-item.hidden { display: none; }
        .ser-btn { 
            width: 100%; 
            padding: 12px 15px; 
            border: none; 
            background: #f8fafd; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            font-family: inherit; 
            font-weight: 700; 
            color: #444; 
            transition: background 0.2s;
        }
        .ser-btn:active { background: #eef2f7; }
        
        .ex-list { display: none; list-style: none; padding: 0; margin: 0; background: white; border-top: 1px solid var(--border); }
        .ex-list.open { display: block; }
        .ex-list.hidden { display: none; }

        .ex-row { 
            padding: 12px 20px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            transition: background 0.2s;
        }
        .ex-row:last-child { border-bottom: none; }
        .ex-row:active { background: #f0f7ff; }
        .ex-row.hidden { display: none; }

        .ex-info { flex-grow: 1; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .ex-num { color: var(--secondary); font-weight: 900; font-size: 0.9em; min-width: 20px; }
        
        /* כפתור מועדפים (כוכב) */
        .fav-btn { padding: 8px; color: #ccc; font-size: 1.2em; transition: color 0.2s, transform 0.2s; }
        .fav-btn.is-fav { color: var(--fav-color); }
        .fav-btn:active { transform: scale(1.3); }

        /* מודאל נגן הווידיאו */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.85); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px);
        }
        .modal-box { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 500px; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .close-x { position: absolute; top: -45px; left: 0; color: white; font-size: 35px; cursor: pointer; padding: 5px; }

        /* אזור שעון הכיול */
        .timer-box { 
            background: #fff5f5; 
            border: 2px solid #ffcfcf; 
            padding: 10px; 
            text-align: center; 
            border-radius: 10px; 
            margin-bottom: 15px; 
        }
        .timer-label { font-size: 0.8em; color: #888; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .timer-val { font-size: 2.2em; font-weight: 900; color: var(--danger); font-family: 'Courier New', monospace; }

        /* נגן YouTube */
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* כפתורי ניווט בתוך המודאל */
        .modal-nav { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .nav-btn { 
            flex: 1; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            transition: opacity 0.2s;
        }
        .nav-btn:active { opacity: 0.8; }
    </style>
</head>
<body>

<header>
    <img src="Logo.png" class="logo-img" onclick="location.reload()" title="רענן דף">
    <div style="text-align: left;">
        <div style="font-weight: 900; color: var(--primary); font-size: 1.1em; line-height: 1.1;">סילבוס IJJA</div>
        <div style="font-size: 0.75em; color: #666; font-weight: 700;">Calibration Mode v2.2.4</div>
    </div>
</header>

<div id="scrollContainer">
    <main class="main-content">
        <div class="toolbar">
            <button id="filterFavBtn" class="btn-tool" onclick="toggleFavFilter()">
                <i class="fas fa-star"></i> מועדפים
            </button>
            <button class="btn-tool" onclick="toggleAll()">
                <i class="fas fa-layer-group"></i> פתח/סגור הכל
            </button>
            <button class="btn-tool" onclick="playRandom()" style="margin-right: auto; color: var(--primary);">
                <i class="fas fa-dice"></i> מבחן אקראי
            </button>
        </div>

        <div id="app">
            <div style="text-align:center; padding: 50px; color: #888;">טוען נתונים...</div>
        </div>
    </main>
</div>

<div id="vModal" class="modal">
    <div class="modal-box">
        <span class="close-x" onclick="closeV()">&times;</span>
        <div id="vName" style="font-weight: 900; text-align: center; color: var(--primary); margin-bottom: 12px; font-size: 1.1em; padding: 0 10px;"></div>

        <div class="timer-box">
            <div class="timer-label">שניות מתחילת ביצוע</div>
            <div class="timer-val"><span id="calDuration">0</span></div>
        </div>

        <div class="video-container">
            <div id="player"></div>
        </div>

        <div class="modal-nav">
            <button class="nav-btn" onclick="globalNav(-1)"><i class="fas fa-chevron-right"></i> הקודם</button>
            <button class="nav-btn" onclick="globalNav(1)">הבא <i class="fas fa-chevron-left"></i></button>
        </div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    let db = [];             // בסיס הנתונים מה-CSV
    let favs = [];           // רשימת IDs של מועדפים
    let isFavOnly = false;   // האם סינון מועדפים פעיל
    let currentEx = null;    // התרגיל המוצג כרגע
    let ytPlayer = null;     // אובייקט הנגן
    let timerInterval = null;
    let currentStartTime = 0;

    /** אתחול האפליקציה **/
    async function init() {
        // טעינת מועדפים מ-LocalStorage
        const saved = localStorage.getItem('ijja_favs');
        if(saved) favs = JSON.parse(saved);

        try {
            // טעינת ה-CSV עם מנגנון למניעת Cache ישן
            const response = await fetch('Black_belt_syllabus_IJJA.csv?v=' + Date.now());
            const text = await response.text();
            db = parseCSV(text);
            render();
            
            // רישום Service Worker לעבודה באופליין
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js');
            }
        } catch(e) {
            document.getElementById('app').innerHTML = '<div style="color:red; text-align:center;">שגיאה בטעינת הנתונים</div>';
        }
    }

    /** עיבוד קובץ ה-CSV **/
    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 10);
        const results = [];
        
        // דילוג על שורת הכותרת
        for(let i=1; i<lines.length; i++) {
            const p = lines[i].split(',');
            if(p.length < 5) continue;
            results.push({
                id: i,
                cat: p[0],    // קטגוריה
                ser: p[1],    // סדרה
                num: p[2],    // מספר תרגיל
                name: p[3],   // שם התרגיל
                link: p[4],   // לינק מקוצר
                embed: p[5]   // לינק להטמעה
            });
        }
        return results;
    }

    /** רינדור רשימת התרגילים **/
    function render() {
        const app = document.getElementById('app');
        let html = '';
        let lastCat = '';
        let lastSer = '';

        db.forEach(ex => {
            // כותרת קטגוריה חדשה
            if (ex.cat !== lastCat) {
                if (lastCat !== '') html += `</div></div>`;
                html += `<div class="cat-group" data-cat="${ex.cat}"><div class="cat-header">${ex.cat}</div>`;
                lastCat = ex.cat;
                lastSer = '';
            }

            // כותרת סדרה חדשה
            if (ex.ser !== lastSer) {
                if (lastSer !== '') html += `</ul></div>`;
                html += `<div class="ser-item" data-ser="${ex.ser}">
                            <button class="ser-btn" onclick="toggleSer(this)">
                                <span>${ex.ser}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <ul class="ex-list">`;
                lastSer = ex.ser;
            }

            // שורת תרגיל
            const isFav = favs.includes(ex.id);
            html += `<li class="ex-row" data-id="${ex.id}">
                        <div class="ex-info" onclick="openVById(${ex.id})">
                            <span class="ex-num">${ex.num}</span>
                            <span>${ex.name}</span>
                        </div>
                        <div class="fav-btn ${isFav?'is-fav':''}" onclick="toggleFav(${ex.id}, this)">
                            <i class="fa${isFav?'s':'r'} fa-star"></i>
                        </div>
                     </li>`;
        });

        app.innerHTML = html + '</ul></div></div>';
        if(isFavOnly) applyFilters();
    }

    /** פתיחה/סגירה של סדרה **/
    function toggleSer(btn) {
        const list = btn.nextElementSibling;
        const icon = btn.querySelector('i');
        list.classList.toggle('open');
        icon.className = list.classList.contains('open') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    }

    /** ניהול מועדפים **/
    function toggleFav(id, el) {
        const index = favs.indexOf(id);
        if (index > -1) favs.splice(index, 1);
        else favs.push(id);
        
        localStorage.setItem('ijja_favs', JSON.stringify(favs));
        el.classList.toggle('is-fav');
        el.querySelector('i').className = favs.includes(id) ? 'fas fa-star' : 'far fa-star';
        
        if(isFavOnly) applyFilters();
    }

    /** סינון מועדפים **/
    function toggleFavFilter() {
        isFavOnly = !isFavOnly;
        document.getElementById('filterFavBtn').classList.toggle('active', isFavOnly);
        applyFilters();
    }

    function applyFilters() {
        document.querySelectorAll('.cat-group').forEach(c => {
            let catHasVisible = false;
            c.querySelectorAll('.ser-item').forEach(s => {
                let serHasVisible = false;
                const list = s.querySelector('.ex-list');
                list.querySelectorAll('.ex-row').forEach(row => {
                    const id = parseInt(row.dataset.id);
                    const hide = isFavOnly && !favs.includes(id);
                    row.classList.toggle('hidden', hide); if(!hide) serHasVisible = true;
                });
                s.classList.toggle('hidden', isFavOnly && !serHasVisible);
                list.classList.toggle('hidden', isFavOnly && !serHasVisible);
                if(serHasVisible) catHasVisible = true;
            });
            c.classList.toggle('hidden', isFavOnly && !catHasVisible);
        });
    }

    /** פתיחה/סגירה גורפת של כל הסדרות **/
    function toggleAll() {
        const anyClosed = Array.from(document.querySelectorAll('.ex-list:not(.hidden)')).some(l => !l.classList.contains('open'));
        document.querySelectorAll('.ex-list').forEach(l => {
            if(!l.classList.contains('hidden')) {
                l.classList.toggle('open', anyClosed);
                const icon = l.previousElementSibling.querySelector('i.fas');
                if(icon) icon.className = anyClosed ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
            }
        });
    }

    /** הפעלת תרגיל אקראי (מצב מבחן) **/
    function playRandom() {
        const pool = db.filter(x => (x.link+x.embed).includes('youtu'));
        if(!pool.length) return;
        const rnd = pool[Math.floor(Math.random() * pool.length)];
        openVById(rnd.id);
    }

    /** נגן YouTube API **/
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', {
            height: '100%',
            width: '100%',
            playerVars: { 'autoplay': 1, 'modestbranding': 1, 'playsinline': 1, 'rel': 0 },
            events: { 'onReady': () => console.log("YT Ready") }
        });
    }

    /** פתיחת המודאל והפעלת וידיאו **/
    function openVById(id) {
        const ex = db.find(x => x.id === id);
        if(!ex) return;
        currentEx = ex;

        document.getElementById('vName').innerText = ex.name;
        document.getElementById('calDuration').innerText = "0";
        document.getElementById('vModal').style.display = 'flex';

        // חילוץ מזהה וידיאו וזמן התחלה
        const url = ex.embed || ex.link;
        let vId = '';
        if (url.includes('v=')) vId = url.split('v=')[1].split('&')[0];
        else if (url.includes('embed/')) vId = url.split('embed/')[1].split('?')[0];
        else if (url.includes('youtu.be/')) vId = url.split('youtu.be/')[1].split('?')[0];

        let start = 0;
        const stMatch = url.match(/[?&](t|start)=([0-9]+)/);
        if(stMatch) start = parseInt(stMatch[2]);
        currentStartTime = start;

        if (ytPlayer && ytPlayer.loadVideoById) {
            ytPlayer.loadVideoById({ videoId: vId, startSeconds: start });
        }
        startTimer();
    }

    /** ניווט בין תרגילים (הבא/הקודם) **/
    function globalNav(dir) {
        if (!currentEx) return;

        // בניית הרשימה הפעילה לניווט (האם אנחנו בסינון מועדפים או בכל הסילבוס)
        const activeList = isFavOnly ? db.filter(ex => favs.includes(ex.id)) : db;
        
        if (activeList.length === 0) return;

        // מציאת המיקום הנוכחי בתוך הרשימה הפעילה
        let currentIndex = activeList.findIndex(ex => ex.id === currentEx.id);
        
        // אם התרגיל הנוכחי לא ברשימה (למשל הוסר מהמועדפים תוך כדי), נתחיל מהראשון
        if (currentIndex === -1) currentIndex = 0;

        let nextIndex = currentIndex + dir;

        // טיפול במעגליות
        if (nextIndex < 0) nextIndex = activeList.length - 1;
        if (nextIndex >= activeList.length) nextIndex = 0;

        openVById(activeList[nextIndex].id);
    }

    /** טיימר כיול **/
    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (ytPlayer && ytPlayer.getCurrentTime) {
                let current = ytPlayer.getCurrentTime();
                let diff = Math.max(0, Math.floor(current - currentStartTime));
                document.getElementById('calDuration').innerText = diff;
            }
        }, 500);
    }

    /** סגירת המודאל **/
    function closeV() {
        document.getElementById('vModal').style.display = 'none';
        if(ytPlayer) ytPlayer.stopVideo();
        clearInterval(timerInterval);
    }

    // הפעלה בטעינה
    window.onload = init;
</script>
</body>
</html>
